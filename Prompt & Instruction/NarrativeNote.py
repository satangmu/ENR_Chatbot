 import os
import pandas as pd
from langchain.chat_models import AzureChatOpenAI
from langchain.prompts import ChatPromptTemplate, FewShotChatMessagePromptTemplate
from langchain.schema import HumanMessage, AIMessage

# Azure OpenAI를 사용하는 객체 생성
chat = AzureChatOpenAI(
    deployment_name='배포 이름',
    model_name='모델 이름',
    temperature=0.5
)



# 기본 프롬프트 템플릿 생성
example_prompt = ChatPromptTemplate.from_messages(
    [
        ("human", "{input}"),
        ("ai", "{output}"),
    ]
)



# 예시 데이터
examples = [
{"input": "낙상 위험 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 이정훈, 남성, 82세\n\n이정훈 씨는 고령 및 최근 다리 수술 이력으로 인해 낙상 위험이 높음. 환자는 보행 시 불안정함을 보이며, 일어서거나 앉을 때 지지가 필요함. 환자는 밤에 화장실을 자주 가는 습관이 있으며, 이동 시 혼자서 움직이려는 경향이 있음.\n\n간호 중재로는 환자의 침대 옆에 낙상 방지 매트를 배치하고, 밤에는 침대 옆 조명을 켜 두어 안전한 환경을 조성함. 환자에게 보행 보조기 사용을 권장하고, 필요 시 보조를 제공하기 위해 호출 벨 사용 방법을 교육함. 또한, 환자의 보행 패턴과 균형을 관찰하며, 필요에 따라 물리치료사와 협력하여 보행 안정성을 개선하기 위한 운동을 계획함.\n\n오후 평가에서 이정훈 씨는 보행 보조기를 사용하여 안전하게 이동하는 것을 선호함을 보고함. 호출 벨을 사용하여 필요 시 간호사의 도움을 요청하였고, 이로 인해 낙상 위험이 감소함. 지속적인 모니터링과 적절한 안전 조치를 통해 환자의 낙상 위험을 최소화하는 데 중점을 두고 있음."},
{"input": "불안정한 혈압 위험 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 김수연, 여성, 75세\n\n김수연 씨는 고혈압 및 심부전 병력으로 인한 불안정한 혈압 위험 상태로 입원함. 입원 당시 혈압은 180/100 mmHg로 측정되었으며, 환자는 두통과 어지러움을 호소함. 정기적인 혈압 측정 결과, 혈압은 일정하지 않고 변동성이 큼.\n\n간호 중재로는 매 시간 혈압 모니터링을 실시하고, 의사의 지시에 따라 혈압 조절 약물을 투여함. 또한, 환자에게 스트레스 감소 및 이완 기법을 교육함. 환자에게 편안한 환경을 조성하여 안정을 취할 수 있도록 함. 수분 섭취와 염분 섭취량을 조절하기 위한 식이 지도도 실시함.\n\n오후에 실시한 혈압 측정에서 김수연 씨의 혈압은 160/90 mmHg로 약간 감소함을 확인함. 환자는 이완 기법을 적용하여 두통과 어지러움이 줄어들었다고 보고함. 지속적인 혈압 모니터링과 적절한 중재를 통해 혈압 안정성을 개선하는 데 중점을 두고 있으며, 혈압 변동성을 최소화하기 위해 지속적인 관리와 교육을 계획함."},
{"input": "근육 긴장 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 안대호, 남성, 45세\n\n안대호 씨는 만성 스트레스와 장시간의 사무직 업무로 인해 심한 근육 긴장 상태로 입원함. 환자는 목과 어깨 부위의 지속적인 긴장과 통증을 호소함. 환자는 장시간 앉아 있을 때 통증이 증가한다고 보고함.\n\n간호 중재로는 환자에게 긴장 완화를 위한 스트레칭과 이완 운동을 교육함. 특히, 목과 어깨의 긴장을 풀어주는 운동에 초점을 맞춤. 또한, 열찜질을 적용하여 근육 긴장을 완화하도록 함. 환자에게 스트레스 관리 방법과 휴식의 중요성에 대해 교육함.\n\n오후 평가에서 안대호 씨는 교육받은 스트레칭과 이완 운동을 수행한 후 통증과 긴장감이 다소 완화됨을 보고함. 열찜질을 통해 근육의 긴장이 줄어들었다고 느낌. 지속적인 모니터링과 적절한 중재를 통해 근육 긴장 상태를 개선하고 통증 관리에 집중할 계획임."},
{"input": "충수염으로 인한 복통 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 박준서, 남성, 30세\n\n박준서 씨는 급성 충수염으로 인한 심한 복통으로 응급실을 통해 입원함. 환자는 오른쪽 하복부에 심한 통증을 호소하며, 통증 점수는 8/10으로 보고됨. 복부 압통 및 경직이 관찰됨. 환자는 메스꺼움과 구토 증상도 함께 보고함.\n\n간호 중재로는 즉시 통증 관리를 위한 진통제를 투여하고, 복부 상태를 지속적으로 관찰함. 환자의 수분 및 영양 상태를 모니터링하고, 필요에 따라 수액 요법을 실시함. 환자에게 안정을 취하도록 권장하고, 의사의 수술적 평가를 위해 준비함.\n\n오후 평가에서 박준서 씨의 복통은 진통제 투여 후 다소 감소함을 보고함. 통증 점수는 5/10으로 감소함. 환자는 구토 증상이 없으며, 안정을 취한 후 상태가 다소 개선됨을 느낌. 의사는 수술적 개입을 결정함. 지속적인 간호 관찰과 적절한 의료적 조치를 통해 환자의 복통 관리 및 회복을 지원할 계획임."},
{"input": "외상성 지주막하 출혈 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 김동욱, 남성, 52세\n\n김동욱 씨는 교통사고로 인한 외상성 지주막하 출혈로 응급실을 통해 입원함. 환자는 의식이 명료하지 않고, 의사소통이 제한적임. 신경학적 평가에서 한쪽 팔다리의 힘이 약해진 것이 관찰됨. 환자의 의식 수준은 Glasgow Coma Scale로 13점으로 평가됨.\n\n간호 중재로는 환자의 신경학적 상태를 2시간마다 평가하고, 중추신경계 압력 관리를 위해 머리를 30도 기울여 놓음. 정맥 수액 요법과 필요에 따른 약물 투여를 실시함. 환자가 의식을 잃거나 다른 신경학적 변화가 있을 경우 즉시 의사에게 알림.\n\n오후 평가에서 김동욱 씨의 의식 수준은 변함없이 유지됨. 한쪽 팔다리의 힘은 여전히 약하나, 추가적인 신경학적 악화 징후는 관찰되지 않음. 환자의 가족에게 상태 업데이트를 제공하고, 치료 및 관리 계획에 대해 설명함. 환자의 상태 변화에 신속하게 대응할 수 있도록 지속적인 감시와 간호 관리를 계획함."},
{"input": "당뇨 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 최영희, 여성, 60세\n\n최영희 씨는 제2형 당뇨병으로 인해 입원함. 환자는 지속적인 피로감과 갈증을 호소함. 혈당 수치는 입원 시 250 mg/dL로 측정됨. 환자는 당뇨병 관리에 대한 지식이 부족하며, 혈당 조절에 어려움을 겪고 있음.\n\n간호 중재로는 혈당 모니터링을 매 식사 전후와 취침 전에 실시함. 의사의 지시에 따라 인슐린 요법과 경구 혈당 조절 약물을 투여함. 환자에게 당뇨병 관리에 대한 교육을 실시하여 식이 조절, 적절한 운동, 혈당 모니터링의 중요성을 강조함. 건강한 생활 습관에 대한 정보를 제공하고, 자가 관리 능력을 향상시키기 위한 전략을 논의함.\n\n오후 평가에서 최영희 씨의 혈당 수치는 180 mg/dL로 감소함을 확인함. 환자는 제공된 교육 내용에 대해 긍정적인 반응을 보이며, 식이 조절과 운동 계획을 세우기로 함. 인슐린 투여와 혈당 조절 약물에 대한 이해도가 향상됨. 지속적인 교육과 모니터링을 통해 환자의 당뇨병 관리 능력을 강화하고, 혈당 조절 상태를 개선하는 데 중점을 두고 있음."},
{"input": "무릎관절증 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 박준호, 남성, 68세\n\n박준호 씨는 무릎관절증으로 인한 지속적인 통증과 운동 범위 제한으로 입원함. 환자는 걷거나 계단을 오르내릴 때 무릎의 통증이 심해진다고 호소함. 무릎의 붓기와 압통이 관찰됨.\n\n간호 중재로는 무릎 통증 관리를 위해 의사의 지시에 따른 진통제를 투여함. 또한, 환자에게 무릎을 보호하고 통증을 줄이기 위한 가벼운 스트레칭과 운동을 교육함. 환자에게 무릎을 쉬게 할 수 있는 적절한 휴식과 활동 균형에 대해 안내함. 물리치료사와 협력하여 환자의 운동 범위를 개선하기 위한 특정 운동을 계획함.\n\n오후 평가에서 박준호 씨의 무릎 통증은 진통제 투여 후 다소 감소함을 보고함. 환자는 교육받은 스트레칭과 운동을 수행하여 무릎의 운동 범위가 조금 개선됨을 느낌. 지속적인 간호 관찰과 적절한 중재를 통해 환자의 무릎관절증 관리에 집중할 계획임."},
{"input": "퇴행성 관절염 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 윤미라, 여성, 72세\n\n윤미라 씨는 퇴행성 관절염으로 인한 지속적인 관절 통증과 운동 범위 제한으로 입원함. 환자는 특히 아침에 일어날 때와 활동 후 무릎과 손목에 심한 통증을 경험함. 관절 부위의 붓기와 뻣뻣함이 관찰됨.\n\n간호 중재로는 환자의 통증 관리를 위해 의사의 지시에 따라 비스테로이드성 항염증제(NSAIDs)를 투여함. 환자에게 관절을 보호하고 통증을 줄이기 위한 가벼운 스트레칭과 운동을 교육함. 환자에게 관절 통증을 완화할 수 있는 적절한 휴식과 활동 균형에 대해 안내함. 물리치료사와 협력하여 환자의 운동 범위를 개선하기 위한 특정 운동을 계획함.\n\n오후 평가에서 윤미라 씨의 관절 통증은 약물 투여 후 감소함을 보고함. 환자는 교육받은 스트레칭과 운동을 수행하여 관절의 운동 범위가 조금 개선됨을 느낌. 지속적인 간호 관찰과 적절한 중재를 통해 환자의 퇴행성 관절염 관리에 집중할 계획임."},
{"input": "통증 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 조은지, 여성, 55세\n\n조은지 씨는 만성 요통으로 인한 지속적인 통증으로 입원함. 환자는 등과 허리 부위에 지속적인 통증을 호소하며, 통증 점수는 7/10으로 보고됨. 통증으로 인해 활동 범위가 제한되며, 장시간 앉아 있거나 서 있을 때 통증이 심해짐.\n\n간호 중재로는 통증 관리를 위해 의사의 지시에 따른 진통제를 투여함. 환자에게 통증 완화를 위한 가벼운 스트레칭과 이완 운동을 교육함. 통증 부위에 대한 온찜질을 적용하여 근육 긴장을 완화하도록 함. 환자에게 적절한 자세 유지와 휴식의 중요성에 대해 안내함.\n\n오후 평가에서 조은지 씨의 통증은 진통제 투여와 온찜질 적용 후 다소 감소함을 보고함. 통증 점수는 5/10으로 감소함. 환자는 교육받은 스트레칭과 운동을 수행하여 통증 관리에 도움이 됨을 느낌. 지속적인 모니터링과 적절한 중재를 통해 환자의 통증 관리와 일상 활동 복귀를 지원할 계획임."},
{"input": "욕창 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 김현수, 남성, 78세\n\n김현수 씨는 장기간의 침상 안정으로 인한 욕창으로 입원함. 환자의 우측 엉덩이 부위에 2단계 욕창이 관찰됨. 욕창 부위는 붉고, 경미한 부기와 통증이 있음.\n\n간호 중재로는 욕창 부위의 정기적인 관리와 감염 예방 조치를 실시함. 욕창 부위를 매일 청결하게 유지하고, 적절한 상처 치료제를 적용함. 환자의 체위 변경을 2시간마다 실시하여 압력 분산을 도와줌. 환자에게 적절한 영양 섭취와 수분 섭취를 권장하여 상처 회복을 촉진함.\n\n오후 평가에서 김현수 씨의 욕창 상태는 상처 관리와 체위 변경으로 인해 개선됨을 확인함. 통증은 다소 감소함. 환자는 상처 부위가 더 건조하고 깨끗해졌다고 느낌. 지속적인 모니터링과 적절한 간호 중재를 통해 욕창의 추가 악화를 예방하고, 상처 회복을 지원할 계획임."},
{"input": "자발적 환기장애 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 정민호, 남성, 56세\n\n정민호 씨는 자발적 환기장애로 인해 입원함. 환자는 호흡 시 흉부 압박감을 호소하며, 호흡이 얕고 빠르게 관찰됨. 호흡수는 분당 30회로 측정됨. 환자는 일상 활동 중에도 호흡곤란을 겪고 있으며, 불안감을 표현함.\n\n간호 중재로는 정기적인 호흡 모니터링과 산소포화도 측정을 실시함. 환자에게 깊게 숨쉬기 및 복식호흡법을 교육함. 이완 기법과 스트레스 관리 전략을 안내하여 환자가 불안감을 줄일 수 있도록 함. 필요에 따라 산소 요법을 실시하여 호흡을 돕고, 환자의 안위를 위해 적절한 환경을 조성함.\n\n오후 평가에서 정민호 씨의 호흡수는 호흡 운동 및 이완 기법 적용 후 분당 24회로 감소함을 확인함. 산소포화도는 95%로 개선됨. 환자는 이완 기법을 통해 불안감이 감소했다고 느낌. 지속적인 모니터링과 적절한 중재를 통해 환자의 호흡 상태와 전반적인 안위를 개선하는 데 중점을 두고 있음."},
{"input": "급성통증 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 김다현, 여성, 33세\n\n김다현 씨는 복부 수술 후 급성통증으로 인해 입원함. 환자는 수술 부위에 심한 통증을 호소하며, 통증 점수는 9/10으로 보고됨. 환자는 통증으로 인해 제한된 움직임과 불편한 자세를 취하고 있음.\n\n간호 중재로는 의사의 지시에 따라 정기적인 진통제 투여를 실시함. 환자에게 효과적인 통증 관리 기법, 예를 들어 호흡 운동과 이완 기법을 교육함. 수술 부위를 지속적으로 관찰하고, 통증이 완화될 수 있도록 적절한 체위 변화를 권장함. 환자의 통증 완화를 위해 정서적 지지를 제공함.\n\n오후 평가에서 김다현 씨의 통증 점수는 6/10으로 감소함을 확인함. 환자는 제공된 통증 관리 기법을 적용하여 통증이 다소 경감됨을 보고함. 수술 부위의 상태는 안정적이며, 추가적인 합병증은 관찰되지 않음. 지속적인 모니터링과 적절한 중재를 통해 환자의 통증 관리와 회복을 지원할 계획임."},
{"input": "고체온 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 오성민, 남성, 40세\n\n오성민 씨는 고열로 인한 고체온으로 입원함. 입원 당시 체온은 39.5°C로 측정되었으며, 환자는 오한과 두통을 호소함. 환자는 최근 감기 증상이 있었으며, 고열로 인한 전반적인 무력감을 느낌.\n\n간호 중재로는 환자의 체온 모니터링을 정기적으로 실시하고, 해열제를 의사의 지시에 따라 투여함. 환자에게 충분한 수분 섭취를 권장하고, 적절한 환기와 실내 온도 조절을 통해 체온 조절을 돕도록 함. 또한, 환자의 전반적인 상태를 관찰하며, 감염의 징후를 모니터링함.\n\n오후 평가에서 오성민 씨의 체온은 38.2°C로 감소함. 환자는 해열제 투여 후 오한과 두통이 줄어들었음을 보고함. 수분 섭취와 적절한 환경 조건 조절이 환자의 불편함을 완화하는 데 도움이 됨. 지속적인 모니터링과 적절한 중재를 통해 환자의 고체온 상태와 전반적인 안위를 관리할 계획임."},
{"input": "분만통증 환자의 간호기록을 Narrative Note 양식으로 작성해줘.", "output": "환자명: 최수정, 여성, 31세\n\n최수정 씨는 분만 중으로, 분만실에 입실함. 환자는 활발한 자궁 수축과 함께 강렬한 분만통증을 경험하고 있음. 수축 간격은 약 3~5분으로, 각 수축 시 통증 점수는 8/10으로 보고됨. 환자는 분만 과정에서 불안과 긴장을 느끼고 있으며, 호흡이 빠르고 얕음.\n\n간호 중재로는 환자에게 효과적인 분만 호흡 기법을 지도함. 람제 호흡과 깊은 복식호흡법을 교육하여 통증 관리를 돕도록 함. 환자의 파트너와 함께 분만 과정에서 환자를 지지하고 격려하는 방법을 안내함. 필요에 따라 의사와 협력하여 통증 완화를 위한 추가적인 조치를 취함.\n\n오후 평가에서 최수정 씨는 분만 호흡 기법을 적용하여 통증을 더 잘 관리할 수 있었다고 보고함. 환자의 불안감은 감소하였으며, 수축 간 휴식을 취할 수 있게 됨. 환자의 파트너는 지원 과정에서 환자를 적극적으로 도우며 긍정적인 영향을 미침. 지속적인 모니터링과 지원을 통해 환자의 분만 과정을 원활하게 진행시킬 계획임."},
]



# FewShotChatMessagePromptTemplate 인스턴스 생성
few_shot_prompt = FewShotChatMessagePromptTemplate(
    example_prompt=example_prompt,
    examples=examples
)

# 추가 지침
instruction = """
You are a nurse working in a general hospital. Answer the question, adhering to the following guidelines:
1. Write in Korean
2. Utilize the information available in the prompt. If relevant information is not found there, then seek answers through other channels.
3. Use precise and concise language. Use endings like 음, 함, 임.
4. Fill out patient information in order
5. Necessary to include "서술 기록 (Narrative Notes)"
6. Create a fictional patient's information.
7. Be as specific as possible.
8. Record precise measurements.
9. Use bullet points for the description instead of using numeric order.
10.Fill in the patient's name, age, and gender, but no other personal information.
11. Give it a different name ex) 김현중, 구진성, 홍선우, 조아라, 최승우, 남하늘, 신영태...
"""



# 최종 프롬프트 템플릿 생성
final_prompt = ChatPromptTemplate.from_messages(
    [
        ("system", instruction),
        ("human", "{input}"),
        ("ai", "{output}"),
    ]
)

# 사용자 질문
# user_question = "지주막하 출혈(Traumatic SAH, Hemorrhage)에 대한 간호기록을 NANDA형식으로 작성해줘"
# message = HumanMessage(content=user_question)

# 체인 구성
chain = final_prompt | chat

# CSV 파일에서 데이터 불러오기
df = pd.read_csv("파일 경로")

# 새로운 데이터셋
new_dataset = []

# 각 행 처리
for index, row in df.iterrows():
    user_question = row['disease name'], "환자의 간호기록 서술 기록 양식으로 작성해줘."  # CSV 파일의 'input' 열에서 질문을 가져옴
    message = HumanMessage(content=user_question)
    response = chain.invoke({"input": user_question, "output": ""})
    new_dataset.append({'input': user_question, 'output': response.content})
    print(response)

# 새로운 데이터셋을 DataFrame으로 변환
new_df = pd.DataFrame(new_dataset)

# 새로운 데이터셋을 CSV 파일로 저장
new_df.to_csv("저장 경로", index=False, encoding='utf-8')
